<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Invoice Generator</title>
    <style>
        /* --- 1. GLOBAL RESET --- */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            display: flex;
            overflow: hidden; /* PC pe scroll na aaye */
        }

        /* --- 2. LAYOUT (PC View) --- */
        .main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* --- LEFT SIDE: EDITOR --- */
        .editor-panel {
            width: 350px;
            flex-shrink: 0;
            background: white;
            padding: 20px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- RIGHT SIDE: PREVIEW --- */
        .preview-panel {
            flex-grow: 1;
            background: #525659;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            padding: 30px;
        }

        /* --- FORM STYLES --- */
        .form-section h2 { margin: 0 0 15px 0; color: #1e88e5; font-size: 18px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        input:focus, textarea:focus, select:focus { border-color: #1e88e5; outline: none; }
        
        .item-list { display: flex; flex-direction: column; gap: 8px; }
        .item-input-row { display: flex; gap: 5px; background: #f9f9f9; padding: 8px; border: 1px solid #eee; border-radius: 4px; }
        
        /* Buttons */
        .btn { border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; width: 100%; }
        .btn-green { background-color: #28a745; margin-top: 10px; }
        .btn-blue { background-color: #1e88e5; margin-top: 20px; font-size: 16px; }
        .btn-red { background-color: #dc3545; width: auto; padding: 5px 10px; font-size: 12px; }
        
        /* Fetch Box */
        .fetch-box { background: #e3f2fd; padding: 10px; border-radius: 6px; border: 1px solid #90caf9; }

        /* --- 3. THE INVOICE PAPER (A4 Logic) --- */
        .paper {
            background: white;
            width: 210mm; /* Exact A4 Width */
            min-height: 297mm; /* Exact A4 Height */
            padding: 15mm; /* Standard Margins */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        /* Invoice Internal Design */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #1e88e5; padding-bottom: 15px; margin-bottom: 20px; }
        .company-name { font-size: 28px; font-weight: bold; color: #1e88e5; text-transform: uppercase; }
        .invoice-title { font-size: 32px; font-weight: 300; color: #333; }
        
        .details-grid { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .client-box h3, .meta-box h3 { font-size: 12px; color: #888; text-transform: uppercase; margin: 0 0 5px 0; }
        .client-val { font-weight: bold; font-size: 14px; }
        .client-addr { font-size: 13px; white-space: pre-wrap; line-height: 1.4; color: #444; }

        /* Table */
        .inv-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .inv-table th { background: #1e88e5; color: white; padding: 8px; text-align: left; font-size: 12px; text-transform: uppercase; }
        .inv-table td { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 13px; }
        .text-right { text-align: right; }
        
        /* Total */
        .total-section { align-self: flex-end; width: 200px; }
        .total-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
        .grand-total { font-size: 18px; font-weight: bold; color: #1e88e5; border-top: 2px solid #ddd; padding-top: 5px; }

        /* Footer */
        .footer { margin-top: auto; padding-top: 40px; display: flex; justify-content: space-between; }
        .sign-box { text-align: center; width: 150px; border-top: 1px solid #aaa; padding-top: 5px; font-size: 12px; color: #666; }

        /* --- 4. RESPONSIVE DESIGN (Mobile) --- */
        @media (max-width: 768px) {
            body { overflow: auto; height: auto; }
            .main-container { flex-direction: column; }
            .editor-panel { width: 100%; border-right: none; border-bottom: 2px solid #1e88e5; height: auto; }
            .preview-panel { padding: 10px; background: #ddd; }
            .paper { width: 100%; min-height: auto; padding: 10px; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }

        /* --- 5. PRINT SETTINGS (Perfect A4) --- */
        @media print {
            @page { size: A4; margin: 0; } /* Remove Browser Margins */
            body { 
                background: white; 
                height: auto; 
                overflow: visible; 
                display: block; 
            }
            .editor-panel { display: none !important; } /* Hide Editor */
            .preview-panel { 
                padding: 0; 
                margin: 0; 
                background: white; 
                width: 100%; 
                display: block; 
                overflow: visible;
            }
            .paper {
                width: 100%;
                max-width: 100%;
                box-shadow: none;
                margin: 0;
                padding: 10mm; /* Print Margin */
                border: none;
                min-height: 290mm; /* Force Full Page */
            }
            /* Ensure table rows don't break weirdly */
            tr { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <div class="editor-panel">
            
            <div class="fetch-box">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <strong style="color:#1565c0; font-size:14px;">üìÖ Auto-Load Order</strong>
                    <button onclick="init()" style="border:none; background:transparent; cursor:pointer;">üîÑ</button>
                </div>
                <select id="order-dropdown" onchange="loadSelectedOrder()">
                    <option value="">Initializing...</option>
                </select>
                <div id="db-status" style="font-size:11px; color:#666; text-align:right; margin-top:3px;">Connecting...</div>
            </div>

            <div class="form-section">
                <h2>üìù Invoice Details</h2>
                <div class="form-group">
                    <label>Invoice No.</label>
                    <input type="text" id="in_number" value="#1" oninput="updateInvoice()">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="in_date" oninput="updateInvoice()">
                </div>
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="in_client_name" oninput="updateInvoice()">
                </div>
                <div class="form-group">
                    <label>Address / Phone</label>
                    <textarea id="in_client_addr" rows="2" oninput="updateInvoice()"></textarea>
                </div>
            </div>

            <div class="form-section">
                <h2>üì¶ Items</h2>
                <div id="items-input-container" class="item-list"></div>
                <button class="btn btn-green" onclick="addItemRow()">+ Add Item</button>
            </div>

            <button class="btn btn-blue" onclick="window.print()">üñ®Ô∏è Print Invoice</button>
        </div>

        <div class="preview-panel">
            <div class="paper">
                
                <div class="header">
                    <div>
                        <div class="company-name" contenteditable="true">TECHDROIDE</div>
                        <div style="font-size:13px; color:#555;" contenteditable="true">Online Store & Accessories</div>
                        <div style="font-size:13px; color:#555;" contenteditable="true">Phone: +91 9518843849</div>
                    </div>
                    <div class="invoice-title">INVOICE</div>
                </div>

                <div class="details-grid">
                    <div class="client-box">
                        <h3>Bill To:</h3>
                        <div class="client-val" id="out_client_name">Name</div>
                        <div class="client-addr" id="out_client_addr">Address</div>
                    </div>
                    <div class="meta-box" style="text-align:right;">
                        <h3>Invoice Details:</h3>
                        <div>Invoice #: <strong id="out_number">#1</strong></div>
                        <div>Date: <strong id="out_date">--/--/----</strong></div>
                    </div>
                </div>

                <table class="inv-table">
                    <thead>
                        <tr>
                            <th width="50%">Description</th>
                            <th width="15%" class="text-right">Price</th>
                            <th width="10%" class="text-right">Qty</th>
                            <th width="25%" class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items-body"></tbody>
                </table>

                <div class="total-section">
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span id="out_grand_total">‚Çπ0.00</span>
                    </div>
                </div>

                <div class="footer">
                    <div class="sign-box">Customer Signature</div>
                    <div class="sign-box">Authorized Signatory</div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ‚ö†Ô∏è PASTE YOUR SCRIPT URL HERE
        // ============================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzgHBpK_fx91pPwnWrommG57NbilZToT3HydsawtS8GF0OWh8kQWWEGdR0f5WQF1632/exec"; 

        document.getElementById('in_date').valueAsDate = new Date();
        let allProducts = [];
        let fetchedOrders = [];

        function init() {
            // 1. Fetch Products
            document.getElementById("db-status").innerText = "Loading Products...";
            fetch(SCRIPT_URL + "?type=products")
            .then(res => res.json())
            .then(data => {
                allProducts = data;
                document.getElementById("db-status").innerText = "Loading Orders...";
                fetchOrders();
            })
            .catch(err => {
                console.log(err);
                fetchOrders(); // Continue even if products fail
            });
        }

        // 2. Fetch Orders
        function fetchOrders() {
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                fetchedOrders = data;
                const dropdown = document.getElementById("order-dropdown");
                dropdown.innerHTML = '<option value="">-- Select Order --</option>';

                if(data.length === 0) { dropdown.innerHTML = '<option>No orders found</option>'; return; }

                // Group by Date
                const grouped = {};
                data.forEach(order => {
                    const d = new Date(order.date);
                    const dateKey = isNaN(d) ? "Others" : d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
                    if(!grouped[dateKey]) grouped[dateKey] = [];
                    grouped[dateKey].push(order);
                });

                for (const [dateLabel, orders] of Object.entries(grouped)) {
                    const group = document.createElement("optgroup");
                    group.label = dateLabel;
                    orders.forEach(order => {
                        const option = document.createElement("option");
                        option.value = order.id;
                        option.text = `${order.id} - ${order.name}`;
                        group.appendChild(option);
                    });
                    dropdown.appendChild(group);
                }
                document.getElementById("db-status").innerText = "‚úÖ Ready";
            })
            .catch(err => document.getElementById("db-status").innerText = "‚ùå Failed");
        }

        // 3. Load Order Logic
        function loadSelectedOrder() {
            const selectedId = document.getElementById("order-dropdown").value;
            if(!selectedId) return;

            const order = fetchedOrders.find(o => o.id === selectedId);
            if(order) {
                // Clear inputs
                document.getElementById("items-input-container").innerHTML = "";

                // Fill Info
                document.getElementById("in_number").value = order.id;
                const d = new Date(order.date);
                if(!isNaN(d)) document.getElementById("in_date").value = d.toISOString().split('T')[0];
                document.getElementById("in_client_name").value = order.name;
                document.getElementById("in_client_addr").value = `${order.address}\nPhone: ${order.phone}`;

                // Parse Items
                if(order.items) {
                    let rawItems = order.items.split(',');
                    rawItems.forEach(raw => {
                        raw = raw.trim();
                        if(!raw) return;

                        let name = raw;
                        let qty = 1;

                        // Check (x2)
                        if (raw.includes("(x")) {
                            let parts = raw.split("(x");
                            name = parts[0].trim();
                            let qtyPart = parts[1].replace(")", "").trim();
                            qty = parseInt(qtyPart) || 1;
                        }

                        // Find Price
                        let price = 0;
                        const product = allProducts.find(p => p.name.toLowerCase() === name.toLowerCase());
                        if(product) price = product.price;
                        else {
                            const partial = allProducts.find(p => name.toLowerCase().includes(p.name.toLowerCase()));
                            if(partial) price = partial.price;
                        }

                        addItemRow(name, price, qty);
                    });
                }
                updateInvoice();
            }
        }

        // 4. UI Functions
        function addItemRow(name = '', price = 0, qty = 1) {
            const container = document.getElementById('items-input-container');
            const div = document.createElement('div');
            div.className = 'item-input-row';
            div.innerHTML = `
                <div style="flex:2;"><input type="text" class="i_name" value="${name}" oninput="updateInvoice()" placeholder="Item"></div>
                <div style="flex:1;"><input type="number" class="i_cost" value="${price}" oninput="updateInvoice()" placeholder="Price"></div>
                <div style="flex:0.5;"><input type="number" class="i_qty" value="${qty}" oninput="updateInvoice()" placeholder="Qty"></div>
                <div style="flex:0.3;"><button class="btn btn-red" onclick="this.parentElement.parentElement.remove(); updateInvoice()">X</button></div>
            `;
            container.appendChild(div);
            updateInvoice();
        }

        function updateInvoice() {
            document.getElementById('out_number').innerText = document.getElementById('in_number').value;
            document.getElementById('out_date').innerText = formatDate(document.getElementById('in_date').value);
            document.getElementById('out_client_name').innerText = document.getElementById('in_client_name').value || "Customer Name";
            document.getElementById('out_client_addr').innerText = document.getElementById('in_client_addr').value || "Address";

            const rows = document.querySelectorAll('.item-input-row');
            const tbody = document.getElementById('invoice-items-body');
            tbody.innerHTML = '';
            let grandTotal = 0;

            rows.forEach(row => {
                const name = row.querySelector('.i_name').value;
                const price = parseFloat(row.querySelector('.i_cost').value) || 0;
                const qty = parseFloat(row.querySelector('.i_qty').value) || 0;
                const total = price * qty;
                grandTotal += total;

                if(name) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${name}</td>
                        <td class="text-right">‚Çπ${price}</td>
                        <td class="text-right">${qty}</td>
                        <td class="text-right">‚Çπ${total}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            document.getElementById('out_grand_total').innerText = "‚Çπ" + grandTotal.toFixed(2);
        }

        function formatDate(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-IN');
        }

        init();
        addItemRow();
    </script>
</body>
</html>
