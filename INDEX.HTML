<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Camera (Real FPS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #000;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }
        #video-feed {
            width: 100%;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1);
        }
        .pulse-record { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        dialog::backdrop {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
        }
        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #eab308;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- Loading Overlay -->
    <div id="loader-overlay" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center transition-opacity duration-300 pointer-events-none opacity-0">
        <div class="loader w-10 h-10 mb-2"></div>
        <span class="text-xs text-gray-400">Configuring Camera...</span>
    </div>

    <video id="video-feed" autoplay playsinline muted></video>

    <!-- Top Info Bar -->
    <div class="absolute top-0 left-0 right-0 p-4 z-30 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
        <!-- Storage -->
        <button onclick="selectStorage()" class="flex items-center gap-2 bg-gray-900/90 border border-gray-700 px-3 py-1.5 rounded-full active:scale-95 transition shadow-lg">
            <i id="storage-icon" data-lucide="smartphone" class="w-3 h-3 text-gray-400"></i>
            <div class="flex flex-col items-start">
                <span class="text-[9px] text-gray-500 uppercase tracking-wider">Saving To</span>
                <span id="storage-name" class="text-[11px] font-bold text-white truncate max-w-[100px]">Gallery</span>
            </div>
        </button>

        <!-- Real Stats Display -->
        <div class="flex gap-2">
            <div onclick="openSettings()" class="flex flex-col items-end px-3 py-1 bg-black/60 rounded-lg border border-white/10 cursor-pointer active:bg-gray-800">
                <span id="real-res" class="text-xs font-bold text-yellow-400 font-mono">LOADING</span>
                <span id="real-fps" class="text-[10px] text-green-400 font-mono">-- FPS</span>
            </div>
            <button onclick="openSettings()" class="p-2 bg-gray-800 rounded-full border border-gray-600 hover:bg-gray-700">
                <i data-lucide="settings-2" class="w-5 h-5 text-white"></i>
            </button>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="absolute bottom-0 w-full pb-8 pt-24 bg-gradient-to-t from-black via-black/80 to-transparent z-20 flex flex-col items-center gap-6">
        
        <!-- Mode Toggle -->
        <div class="flex bg-gray-900 p-1 rounded-full border border-gray-700 relative w-48">
            <div id="mode-bg" class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-yellow-500 rounded-full transition-transform duration-300"></div>
            <button onclick="setMode('photo')" class="flex-1 relative z-10 text-xs font-bold py-2 text-center transition-colors" id="txt-photo">PHOTO</button>
            <button onclick="setMode('video')" class="flex-1 relative z-10 text-xs font-bold py-2 text-center text-gray-400 transition-colors" id="txt-video">VIDEO</button>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-around w-full px-6">
            <!-- Last Preview -->
            <div class="w-12 h-12 bg-gray-800 rounded-xl overflow-hidden border border-gray-600 relative">
                <img id="preview-img" class="w-full h-full object-cover hidden">
            </div>

            <!-- Shutter -->
            <div class="relative">
                <button id="btn-shutter-photo" onclick="capturePhoto()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center active:scale-90 transition">
                    <div class="w-16 h-16 bg-white rounded-full"></div>
                </button>
                <button id="btn-shutter-video" onclick="toggleVideo()" class="hidden w-20 h-20 rounded-full border-4 border-white flex items-center justify-center active:scale-90 transition">
                    <div id="rec-dot" class="w-16 h-16 bg-red-600 rounded-full transition-all duration-300"></div>
                </button>
            </div>

            <!-- Flip Camera -->
            <button onclick="flipCamera()" class="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center border border-gray-600 active:rotate-180 transition duration-500">
                <i data-lucide="refresh-ccw" class="w-5 h-5 text-white"></i>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <dialog id="settings-modal" class="bg-gray-900 text-white rounded-2xl w-80 p-0 shadow-2xl overflow-hidden border border-gray-700">
        <div class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
            <span class="font-bold flex items-center gap-2"><i data-lucide="sliders" class="w-4 h-4 text-yellow-500"></i> Settings</span>
            <button onclick="document.getElementById('settings-modal').close()" class="p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-5 space-y-6">
            <!-- Resolution -->
            <div>
                <div class="text-xs text-gray-400 font-bold mb-2 uppercase">Resolution (Quality)</div>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="applySettings('4k', currentFps)" id="btn-4k" class="p-2 text-xs font-bold bg-gray-700 rounded border border-gray-600 hover:bg-gray-600">4K UHD</button>
                    <button onclick="applySettings('1080p', currentFps)" id="btn-1080p" class="p-2 text-xs font-bold bg-yellow-500 text-black rounded border border-yellow-600">1080p</button>
                    <button onclick="applySettings('720p', currentFps)" id="btn-720p" class="p-2 text-xs font-bold bg-gray-700 rounded border border-gray-600 hover:bg-gray-600">720p</button>
                </div>
            </div>
            <!-- FPS -->
            <div>
                <div class="text-xs text-gray-400 font-bold mb-2 uppercase">Target FPS (Smoothness)</div>
                <div class="flex gap-2">
                    <button onclick="applySettings(currentRes, 30)" id="btn-30fps" class="flex-1 p-2 text-xs font-bold bg-yellow-500 text-black rounded border border-yellow-600">30 FPS</button>
                    <button onclick="applySettings(currentRes, 60)" id="btn-60fps" class="flex-1 p-2 text-xs font-bold bg-gray-700 rounded border border-gray-600 hover:bg-gray-600">60 FPS</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2">Note: 60FPS requires good light. Front cameras usually limit to 30FPS.</p>
            </div>
        </div>
    </dialog>

    <!-- Canvas/Hidden -->
    <canvas id="canvas" class="hidden"></canvas>
    
    <!-- Toast -->
    <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/90 text-white px-6 py-3 rounded-xl border border-gray-700 opacity-0 pointer-events-none transition z-50 flex items-center gap-3">
        <i id="t-icon" data-lucide="check" class="text-green-500"></i>
        <span id="t-msg" class="font-bold text-sm">Saved</span>
    </div>

    <script>
        lucide.createIcons();

        // State
        let stream = null;
        let mediaRecorder = null;
        let chunks = [];
        let isRecording = false;
        let currentRes = '1080p';
        let currentFps = 30;
        let facingMode = 'environment'; // Default Back Camera
        let directoryHandle = null;

        // Elements
        const video = document.getElementById('video-feed');
        const loader = document.getElementById('loader-overlay');
        
        // --- 1. CORE CAMERA ENGINE ---
        async function startCamera() {
            showLoader(true);
            if (stream) stream.getTracks().forEach(t => t.stop());

            // Define strict constraints based on selection
            let constraints = {
                audio: true,
                video: {
                    facingMode: facingMode
                }
            };

            // Resolution Logic
            if (currentRes === '4k') {
                constraints.video.width = { min: 3840, ideal: 3840 };
                constraints.video.height = { min: 2160, ideal: 2160 };
            } else if (currentRes === '1080p') {
                constraints.video.width = { min: 1920, ideal: 1920 };
                constraints.video.height = { min: 1080, ideal: 1080 };
            } else {
                constraints.video.width = { ideal: 1280 };
                constraints.video.height = { ideal: 720 };
            }

            // FPS Logic (Strict priority)
            if (currentFps === 60) {
                constraints.video.frameRate = { min: 30, ideal: 60 }; // Try hard for 60
            } else {
                constraints.video.frameRate = { ideal: 30 };
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for stream to stabilize then check REAL stats
                video.onloadedmetadata = () => {
                    setTimeout(analyzeStream, 500);
                    showLoader(false);
                };
                
                // Update Mirroring
                video.style.transform = facingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';

            } catch (err) {
                console.error(err);
                showLoader(false);
                alert("Error: Camera not supported or Settings too high for this device.");
                // Fallback to basic if 4K fails
                if (currentRes === '4k') {
                    currentRes = '1080p';
                    startCamera();
                }
            }
        }

        // --- 2. REALITY CHECK (Does the setting actually work?) ---
        function analyzeStream() {
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            
            const w = settings.width;
            const h = settings.height;
            const fps = settings.frameRate ? Math.round(settings.frameRate) : 30;

            // Update Top Badge with REAL data
            let resLabel = "SD";
            if (w >= 3800) resLabel = "4K UHD";
            else if (w >= 1900) resLabel = "1080p";
            else if (w >= 1200) resLabel = "720p";
            
            document.getElementById('real-res').innerText = resLabel;
            document.getElementById('real-fps').innerText = `${fps} FPS`;

            // Color code FPS (Green for 60, Gray for 30)
            document.getElementById('real-fps').className = fps >= 45 
                ? "text-[10px] text-green-400 font-mono" 
                : "text-[10px] text-gray-400 font-mono";
        }

        // --- 3. SETTINGS HANDLING ---
        function applySettings(res, fps) {
            currentRes = res;
            currentFps = fps;
            
            // UI Update
            updateSettingsUI();
            
            // Close Modal & Restart Camera
            document.getElementById('settings-modal').close();
            startCamera(); 
        }

        function updateSettingsUI() {
            // Reset all buttons
            ['4k', '1080p', '720p'].forEach(r => {
                const btn = document.getElementById(`btn-${r}`);
                btn.className = `p-2 text-xs font-bold rounded border ${currentRes === r ? 'bg-yellow-500 text-black border-yellow-600' : 'bg-gray-700 border-gray-600 hover:bg-gray-600'}`;
            });

            [30, 60].forEach(f => {
                const btn = document.getElementById(`btn-${f}fps`);
                btn.className = `flex-1 p-2 text-xs font-bold rounded border ${currentFps === f ? 'bg-yellow-500 text-black border-yellow-600' : 'bg-gray-700 border-gray-600 hover:bg-gray-600'}`;
            });
        }

        function openSettings() {
            updateSettingsUI(); // Ensure UI matches state
            document.getElementById('settings-modal').showModal();
        }

        // --- 4. STORAGE & SAVING ---
        async function selectStorage() {
            if ('showDirectoryPicker' in window) {
                try {
                    directoryHandle = await window.showDirectoryPicker({id: 'cam_pro', mode: 'readwrite'});
                    document.getElementById('storage-name').innerText = directoryHandle.name;
                    document.getElementById('storage-icon').classList.replace('text-gray-400', 'text-green-400');
                    showToast("Storage Linked", "success");
                } catch(e) {}
            } else {
                alert("Folder selection not supported. Files will download manually.");
            }
        }

        async function saveFile(blob, name) {
            try {
                if (directoryHandle) {
                    const fh = await directoryHandle.getFileHandle(name, { create: true });
                    const w = await fh.createWritable();
                    await w.write(blob);
                    await w.close();
                    showToast(`Saved to ${directoryHandle.name}`, "success");
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = name;
                    a.click();
                    showToast("Saved to Downloads", "success");
                }
            } catch (e) {
                showToast("Save Failed", "error");
            }
        }

        // --- 5. CAPTURE LOGIC ---
        async function capturePhoto() {
            // Flash
            const flash = document.createElement('div');
            flash.className = "fixed inset-0 bg-white z-50 transition-opacity duration-150";
            document.body.appendChild(flash);
            setTimeout(() => flash.style.opacity = 0, 50);
            setTimeout(() => flash.remove(), 200);

            // Capture high quality frame
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            if (facingMode === 'user') { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(b => {
                document.getElementById('preview-img').src = URL.createObjectURL(b);
                document.getElementById('preview-img').classList.remove('hidden');
                saveFile(b, `IMG_${Date.now()}.png`);
            }, 'image/png', 1.0);
        }

        function toggleVideo() {
            if (!isRecording) {
                chunks = [];
                // High Bitrate Recording
                const options = { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 12000000 }; // 12 Mbps
                try { mediaRecorder = new MediaRecorder(stream, options); }
                catch(e) { mediaRecorder = new MediaRecorder(stream); } // Fallback

                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    document.getElementById('preview-img').src = URL.createObjectURL(blob); // Thumbnail workaround
                    document.getElementById('preview-img').classList.remove('hidden');
                    saveFile(blob, `VID_${Date.now()}.webm`);
                };
                
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('rec-dot').classList.add('scale-50', 'rounded-md');
                document.getElementById('btn-shutter-video').classList.add('pulse-record');
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('rec-dot').classList.remove('scale-50', 'rounded-md');
                document.getElementById('btn-shutter-video').classList.remove('pulse-record');
            }
        }

        // --- 6. HELPERS ---
        function setMode(m) {
            const photoBtn = document.getElementById('btn-shutter-photo');
            const videoBtn = document.getElementById('btn-shutter-video');
            const modeBg = document.getElementById('mode-bg');
            const tPhoto = document.getElementById('txt-photo');
            const tVideo = document.getElementById('txt-video');

            if (m === 'photo') {
                modeBg.style.transform = "translateX(0)";
                tPhoto.className = "flex-1 relative z-10 text-xs font-bold py-2 text-center text-black transition-colors";
                tVideo.className = "flex-1 relative z-10 text-xs font-bold py-2 text-center text-gray-400 transition-colors";
                photoBtn.classList.remove('hidden');
                videoBtn.classList.add('hidden');
            } else {
                modeBg.style.transform = "translateX(100%)";
                tPhoto.className = "flex-1 relative z-10 text-xs font-bold py-2 text-center text-gray-400 transition-colors";
                tVideo.className = "flex-1 relative z-10 text-xs font-bold py-2 text-center text-black transition-colors";
                photoBtn.classList.add('hidden');
                videoBtn.classList.remove('hidden');
            }
        }

        function flipCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            startCamera();
        }

        function showLoader(show) {
            loader.style.opacity = show ? 1 : 0;
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('t-msg').innerText = msg;
            document.getElementById('t-icon').className = type === 'success' ? "text-green-500" : "text-red-500";
            document.getElementById('t-icon').setAttribute('data-lucide', type === 'success' ? "check" : "alert-circle");
            lucide.createIcons();
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2500);
        }

        // Init
        startCamera();

    </script>
</body>
</html>