<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Invoice</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e0e0e0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .form-container { width: 35%; background: white; padding: 20px; height: 100%; overflow-y: auto; box-sizing: border-box; border-top: 5px solid #1e88e5; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .item-row { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; background: #f9f9f9; border-radius: 6px; display: flex; flex-direction: column; gap: 5px; }
        .row-inputs { display: flex; gap: 5px; }
        .btn { padding: 10px; cursor: pointer; border: none; border-radius: 5px; color: white; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-add { background-color: #28a745; }
        .btn-remove { background-color: #ff4d4d; }
        .btn-print { background-color: #1e88e5; margin-top: 20px; font-size: 16px; padding: 15px; }
        .fetch-box { background-color: #e3f2fd; border: 1px solid #90caf9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .status-text { font-size: 11px; color: #666; margin-top: 5px; text-align: right; display: block;}
        .preview-wrapper { width: 65%; background: #525659; overflow-y: auto; padding: 20px; display: flex; justify-content: center; }
        .invoice-paper { background: white; width: 100%; max-width: 21cm; min-height: 29.7cm; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .inv-header { background-color: #1e88e5; color: white; padding: 30px; text-align: right; }
        .inv-header h1 { margin: 0; font-size: 32px; letter-spacing: 2px; }
        .inv-body { padding: 30px; flex-grow: 1; display: flex; flex-direction: column; }
        .shop-info { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .client-meta { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .meta-right { text-align: right; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #1e88e5; border-bottom: 2px solid #1e88e5; padding: 8px; font-size: 12px; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 13px; }
        .text-right { text-align: right; }
        .total-box { margin-top: 20px; align-self: flex-end; width: 250px; font-size: 18px; font-weight: bold; color: #1e88e5; border-top: 2px solid #eee; padding-top: 10px; display: flex; justify-content: space-between; }
        @media print { body { display: block; height: auto; } .form-container { display: none; } .preview-wrapper { width: 100%; padding: 0; display: block; } .invoice-paper { box-shadow: none; } }
    </style>
</head>
<body>

    <div class="form-container">
        <div class="fetch-box">
            <h3 style="margin:0 0 10px 0; color:#1565c0;">üìÖ Auto-Load Order</h3>
            <label style="font-size:11px;">Select Order ID:</label>
            <select id="order-dropdown" onchange="loadSelectedOrder()">
                <option value="">Initializing...</option>
            </select>
            <span class="status-text" id="db-status">Connecting...</span>
        </div>

        <h2 style="margin:0 0 15px 0; font-size:18px; border-bottom:2px solid #eee; padding-bottom:10px;">üìù Invoice Details</h2>
        <div class="form-group"><label>Invoice No.</label><input type="text" id="in_number" value="#1" oninput="updateInvoice()"></div>
        <div class="form-group"><label>Date</label><input type="date" id="in_date" oninput="updateInvoice()"></div>
        <div class="form-group"><label>Customer Name</label><input type="text" id="in_client_name" oninput="updateInvoice()"></div>
        <div class="form-group"><label>Address / Phone</label><textarea id="in_client_addr" rows="3" oninput="updateInvoice()"></textarea></div>

        <h3 style="margin:15px 0 10px 0; font-size:14px;">Items List</h3>
        <div id="items-container"></div>
        <button class="btn btn-add" onclick="addItemRow()">+ Add Item Manually</button>
        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
    </div>

    <div class="preview-wrapper">
        <div class="invoice-paper">
            <div class="inv-header"><h1>INVOICE</h1></div>
            <div class="inv-body">
                <div class="shop-info">
                    <div style="font-size:20px; font-weight:bold; color:#1e88e5;">TECHDROIDE</div>
                    <div style="font-size:13px;">Online Store & Accessories</div>
                </div>
                <div class="client-meta">
                    <div>
                        <div style="font-size:11px; color:#888;">Bill To</div>
                        <div id="out_client_name" style="font-weight:bold; font-size:15px;">Name</div>
                        <div id="out_client_addr" style="font-size:13px;">Address</div>
                    </div>
                    <div class="meta-right">
                        <div style="font-size:11px; color:#888;">Invoice #</div>
                        <div id="out_number" style="font-weight:bold; margin-bottom:10px;">#1</div>
                        <div style="font-size:11px; color:#888;">Date</div>
                        <div id="out_date">--/--/----</div>
                    </div>
                </div>
                <table>
                    <thead><tr><th width="50%">Item</th><th width="15%" class="text-right">Price</th><th width="10%" class="text-right">Qty</th><th width="25%" class="text-right">Amount</th></tr></thead>
                    <tbody id="invoice-items"></tbody>
                </table>
                <div class="total-box"><span>Total</span><span id="out_grand_total">‚Çπ0.00</span></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ‚ö†Ô∏è PASTE YOUR NEW SCRIPT URL HERE
        // ============================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzgHBpK_fx91pPwnWrommG57NbilZToT3HydsawtS8GF0OWh8kQWWEGdR0f5WQF1632/exec"; 

        document.getElementById('in_date').valueAsDate = new Date();
        let allProducts = [];
        let fetchedOrders = [];

        function init() {
            // 1. Fetch Products via Apps Script
            document.getElementById("db-status").innerText = "Loading Products...";
            fetch(SCRIPT_URL + "?type=products")
            .then(res => res.json())
            .then(data => {
                allProducts = data;
                document.getElementById("db-status").innerText = "Products Loaded. Fetching Orders...";
                fetchOrders();
            })
            .catch(err => {
                console.error(err);
                document.getElementById("db-status").innerText = "‚ùå Product Fetch Failed";
            });
        }

        // 2. Fetch Orders via Apps Script
        function fetchOrders() {
            fetch(SCRIPT_URL) // Default type is 'orders'
            .then(res => res.json())
            .then(data => {
                fetchedOrders = data;
                const dropdown = document.getElementById("order-dropdown");
                dropdown.innerHTML = '<option value="">-- Select Order --</option>';

                if(data.length === 0) { dropdown.innerHTML = '<option>No orders found</option>'; return; }

                // Date Grouping
                const grouped = {};
                data.forEach(order => {
                    const d = new Date(order.date);
                    const dateKey = isNaN(d) ? "Others" : d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
                    if(!grouped[dateKey]) grouped[dateKey] = [];
                    grouped[dateKey].push(order);
                });

                for (const [dateLabel, orders] of Object.entries(grouped)) {
                    const group = document.createElement("optgroup");
                    group.label = dateLabel;
                    orders.forEach(order => {
                        const option = document.createElement("option");
                        option.value = order.id;
                        option.text = `${order.id} - ${order.name}`;
                        group.appendChild(option);
                    });
                    dropdown.appendChild(group);
                }
                document.getElementById("db-status").innerText = "‚úÖ System Ready";
            })
            .catch(err => {
                console.error(err);
                document.getElementById("db-status").innerText = "‚ùå Order Fetch Failed";
            });
        }

        // 3. Auto Fill Logic
        function loadSelectedOrder() {
            const selectedId = document.getElementById("order-dropdown").value;
            if(!selectedId) return;
            const order = fetchedOrders.find(o => o.id === selectedId);
            
            if(order) {
                document.getElementById("in_number").value = order.id;
                const d = new Date(order.date);
                if(!isNaN(d)) document.getElementById("in_date").value = d.toISOString().split('T')[0];
                document.getElementById("in_client_name").value = order.name;
                document.getElementById("in_client_addr").value = `${order.address}\nPhone: ${order.phone}`;

                const container = document.getElementById("items-container");
                container.innerHTML = ""; 

                if(order.items) {
                    const itemsArray = order.items.split(', ');
                    itemsArray.forEach(itemStr => {
                        const match = itemStr.match(/(.*) \(x(\d+)\)/);
                        let name = itemStr.replace(/ \(x\d+\)/, "").trim();
                        let qty = 1;
                        let price = 0;

                        if(match) { name = match[1].trim(); qty = parseInt(match[2]); }

                        // Fuzzy Search Price
                        const foundProduct = allProducts.find(p => 
                            p.name.toLowerCase().includes(name.toLowerCase()) || 
                            name.toLowerCase().includes(p.name.toLowerCase())
                        );
                        if(foundProduct) price = foundProduct.price;

                        addItemRow(name, price, qty);
                    });
                }
                updateInvoice();
            }
        }

        function addItemRow(name = '', price = 0, qty = 1) {
            const container = document.getElementById('items-container');
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <input type="text" placeholder="Item Name" class="i_name" value="${name}" oninput="updateInvoice()">
                <div class="row-inputs">
                    <input type="number" placeholder="Price" class="i_cost" value="${price}" oninput="updateInvoice()">
                    <input type="number" placeholder="Qty" class="i_qty" value="${qty}" oninput="updateInvoice()">
                    <button class="btn btn-remove" style="width:auto; margin:0;" onclick="this.parentElement.parentElement.remove(); updateInvoice()">X</button>
                </div>`;
            container.appendChild(div);
            updateInvoice();
        }

        function updateInvoice() {
            document.getElementById('out_number').innerText = document.getElementById('in_number').value;
            document.getElementById('out_date').innerText = formatDate(document.getElementById('in_date').value);
            document.getElementById('out_client_name').innerText = document.getElementById('in_client_name').value || "Name";
            document.getElementById('out_client_addr').innerText = document.getElementById('in_client_addr').value || "Address";

            const rows = document.querySelectorAll('.item-row');
            const tbody = document.getElementById('invoice-items');
            tbody.innerHTML = '';
            let grandTotal = 0;

            rows.forEach(row => {
                const name = row.querySelector('.i_name').value;
                const price = parseFloat(row.querySelector('.i_cost').value) || 0;
                const qty = parseFloat(row.querySelector('.i_qty').value) || 0;
                const total = price * qty;
                grandTotal += total;

                if(name || price || qty) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><div style="font-weight:bold;">${name}</div></td><td class="text-right">‚Çπ${price}</td><td class="text-right">${qty}</td><td class="text-right">‚Çπ${total}</td>`;
                    tbody.appendChild(tr);
                }
            });
            document.getElementById('out_grand_total').innerText = "‚Çπ" + grandTotal.toFixed(2);
        }

        function formatDate(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-IN');
        }

        init();
        addItemRow(); 
    </script>
</body>
</html>
