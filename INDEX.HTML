<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro USB Camera + Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #000;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            font-family: sans-serif;
        }
        #video-feed {
            width: 100%;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1);
        }
        .pulse-record { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* Settings Modal Blur */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- Flash Layer -->
    <div id="flash-layer" class="absolute inset-0 pointer-events-none z-50 opacity-0 bg-white transition-opacity duration-150"></div>

    <!-- Camera Feed -->
    <video id="video-feed" autoplay playsinline muted></video>

    <!-- Top Bar -->
    <div class="absolute top-0 left-0 right-0 p-4 z-30 bg-gradient-to-b from-black/90 to-transparent flex justify-between items-start">
        
        <!-- Storage Button -->
        <button onclick="selectStorage()" class="flex items-center gap-2 bg-gray-900/80 backdrop-blur-md border border-gray-700 px-3 py-1.5 rounded-full active:scale-95 transition-all shadow-lg">
            <div id="storage-icon-bg" class="bg-gray-700 p-1 rounded-full">
                <i id="storage-icon" data-lucide="smartphone" class="w-3 h-3 text-white"></i>
            </div>
            <div class="flex flex-col items-start">
                <span class="text-[9px] text-gray-400 uppercase tracking-widest">Save To</span>
                <span id="storage-name" class="text-[11px] font-bold text-white truncate max-w-[80px]">Gallery</span>
            </div>
            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-500"></i>
        </button>

        <!-- Quality & Settings -->
        <div class="flex gap-2">
             <!-- Quality Badge (Click to open settings) -->
            <button onclick="openSettings()" class="flex flex-col items-end justify-center px-3 py-1 bg-black/40 backdrop-blur rounded-lg border border-white/10 active:scale-95 transition">
                <span id="res-badge" class="text-xs font-bold text-yellow-400 font-mono">HD</span>
                <span id="fps-badge" class="text-[10px] text-gray-300 font-mono">30 FPS</span>
            </button>
            
            <button onclick="openSettings()" class="p-2 bg-white/10 rounded-full backdrop-blur-md hover:bg-white/20">
                <i data-lucide="settings-2" class="w-5 h-5 text-white"></i>
            </button>
        </div>
    </div>

    <!-- Timer -->
    <div id="timer-pill" class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-red-600/90 text-white px-4 py-1 rounded-full text-sm font-mono hidden flex items-center gap-2 z-20 shadow-xl border border-red-400/50">
        <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
        <span id="timer-text">00:00</span>
    </div>

    <!-- Bottom Controls -->
    <div class="absolute bottom-0 w-full pb-8 pt-20 bg-gradient-to-t from-black via-black/70 to-transparent z-20 flex flex-col items-center gap-6">
        
        <!-- Mode Switcher -->
        <div class="flex bg-gray-900/80 p-1 rounded-full backdrop-blur-md border border-white/10 relative">
            <div id="mode-indicator" class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-yellow-500 rounded-full transition-all duration-300 z-0"></div>
            <button onclick="setMode('photo')" class="relative z-10 px-6 py-1.5 rounded-full text-sm font-bold transition-colors duration-300" id="btn-photo">Photo</button>
            <button onclick="setMode('video')" class="relative z-10 px-6 py-1.5 rounded-full text-sm font-bold transition-colors duration-300 text-gray-400" id="btn-video">Video</button>
        </div>

        <!-- Main Actions -->
        <div class="flex items-center justify-around w-full px-8">
            <div onclick="openGalleryTip()" class="w-12 h-12 rounded-xl bg-gray-800 border border-gray-600 overflow-hidden relative cursor-pointer active:scale-90 transition">
                <img id="last-preview" class="w-full h-full object-cover hidden">
                <div id="no-preview" class="w-full h-full flex items-center justify-center text-gray-600"><i data-lucide="image" class="w-5 h-5"></i></div>
            </div>

            <div class="relative">
                <button id="shutter-photo" onclick="capturePhoto()" class="w-20 h-20 rounded-full border-[4px] border-white flex items-center justify-center active:scale-95 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                    <div class="w-16 h-16 bg-white rounded-full"></div>
                </button>
                <button id="shutter-video" onclick="toggleRecording()" class="hidden w-20 h-20 rounded-full border-[4px] border-white flex items-center justify-center active:scale-95 transition-transform shadow-[0_0_20px_rgba(220,38,38,0.4)]">
                    <div id="video-inner" class="w-16 h-16 bg-red-600 rounded-full transition-all duration-300"></div>
                </button>
            </div>

            <button onclick="flipCamera()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center backdrop-blur active:rotate-180 transition-all duration-500">
                <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <dialog id="settings-modal" class="bg-[#1a1a1a] text-white p-0 rounded-2xl w-80 max-w-[90vw] shadow-2xl border border-gray-700 overflow-hidden">
        <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-900">
            <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="sliders" class="w-4 h-4 text-yellow-500"></i> Camera Settings</h3>
            <button onclick="closeSettings()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <div class="p-5 space-y-6">
            <!-- Resolution Selector -->
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-3 block">Video Resolution</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="applyQuality('4k')" id="btn-res-4k" class="res-btn p-2 rounded-lg bg-gray-800 border border-gray-600 text-xs font-bold hover:bg-gray-700">4K (UHD)</button>
                    <button onclick="applyQuality('1080p')" id="btn-res-1080p" class="res-btn p-2 rounded-lg bg-gray-800 border border-gray-600 text-xs font-bold hover:bg-gray-700">1080p (FHD)</button>
                    <button onclick="applyQuality('720p')" id="btn-res-720p" class="res-btn p-2 rounded-lg bg-gray-800 border border-gray-600 text-xs font-bold hover:bg-gray-700">720p (HD)</button>
                </div>
            </div>

            <!-- FPS Selector -->
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-3 block">Frame Rate (FPS)</label>
                <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-600">
                    <button onclick="applyFPS(30)" id="btn-fps-30" class="fps-btn flex-1 py-2 text-xs font-bold rounded-md transition-colors">30 FPS</button>
                    <button onclick="applyFPS(60)" id="btn-fps-60" class="fps-btn flex-1 py-2 text-xs font-bold rounded-md transition-colors">60 FPS</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2">*60 FPS requires good lighting.</p>
            </div>
        </div>
        
        <div class="p-4 bg-gray-900 text-center border-t border-gray-700">
            <button onclick="closeSettings()" class="bg-yellow-500 text-black font-bold py-2 px-8 rounded-full text-sm shadow-lg active:scale-95 transition">Done</button>
        </div>
    </dialog>

    <!-- Toast -->
    <div id="toast" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/90 border border-gray-700 text-white px-6 py-4 rounded-2xl shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 flex flex-col items-center gap-1 min-w-[180px]">
        <i id="toast-icon" data-lucide="check" class="w-8 h-8 text-green-500 mb-1"></i>
        <span id="toast-msg" class="font-bold">Saved!</span>
        <span id="toast-sub" class="text-xs text-gray-400">Details here</span>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        lucide.createIcons();

        // State
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let mode = 'photo';
        let facingMode = 'environment'; // Default to Back Camera for quality
        let directoryHandle = null;
        let timerInt = null;
        
        // Settings State
        let currentRes = '1080p'; // Default
        let currentFPS = 30;

        // Elements
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const modal = document.getElementById('settings-modal');

        // --- 1. Advanced Camera Setup ---
        async function startCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            
            // Constraint Logic based on User Selection
            let width, height;
            if(currentRes === '4k') { width = 3840; height = 2160; }
            else if(currentRes === '1080p') { width = 1920; height = 1080; }
            else { width = 1280; height = 720; }

            const constraints = {
                video: { 
                    facingMode: facingMode,
                    width: { ideal: width }, // Use ideal so it doesn't crash if not supported
                    height: { ideal: height },
                    frameRate: { ideal: currentFPS }
                },
                audio: true
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Check what we actually got
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                updateStatsUI(settings.width, settings.height, settings.frameRate);
                
                // Mirror selfie
                video.style.transform = facingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
            } catch (e) {
                console.error(e);
                alert("Camera access error. Please allow permissions.");
            }
        }

        function updateStatsUI(w, h, f) {
            // Determine Label
            let label = "SD";
            if (w >= 3800 || h >= 2100) label = "4K";
            else if (w >= 1900 || h >= 1000) label = "FHD";
            else if (w >= 1200 || h >= 700) label = "HD";
            
            document.getElementById('res-badge').innerText = label;
            document.getElementById('fps-badge').innerText = (Math.round(f) || 30) + " FPS";
            
            // Update Modal UI Active State
            document.querySelectorAll('.res-btn').forEach(b => b.classList.replace('bg-yellow-500', 'bg-gray-800'));
            document.querySelectorAll('.res-btn').forEach(b => b.classList.replace('text-black', 'text-white'));
            
            document.querySelectorAll('.fps-btn').forEach(b => b.classList.replace('bg-gray-600', 'transparent'));
            document.querySelectorAll('.fps-btn').forEach(b => b.classList.remove('text-white'));

            // Highlight current selection buttons logic (Simplified visual sync)
            if(currentRes) {
                const btn = document.getElementById(`btn-res-${currentRes}`);
                if(btn) {
                    btn.classList.replace('bg-gray-800', 'bg-yellow-500');
                    btn.classList.replace('text-white', 'text-black');
                }
            }
            const fpsBtn = document.getElementById(`btn-fps-${currentFPS}`);
            if(fpsBtn) {
                fpsBtn.classList.add('bg-gray-600', 'text-white');
            }
        }

        // --- 2. Settings Logic ---
        function openSettings() { modal.showModal(); }
        function closeSettings() { modal.close(); }

        function applyQuality(res) {
            currentRes = res;
            startCamera(); // Restart with new settings
        }

        function applyFPS(fps) {
            currentFPS = fps;
            startCamera(); // Restart
        }

        // --- 3. Storage & Saving ---
        async function selectStorage() {
            if ('showDirectoryPicker' in window) {
                try {
                    const handle = await window.showDirectoryPicker({ id: 'cam_store', mode: 'readwrite' });
                    directoryHandle = handle;
                    document.getElementById('storage-name').innerText = handle.name;
                    document.getElementById('storage-icon-bg').classList.replace('bg-gray-700', 'bg-green-600');
                    showToast("Linked: " + handle.name, "success", "Saving here now");
                } catch(e) {}
            } else {
                alert("Use Chrome/Edge for folder selection. Files will default to Downloads.");
            }
        }

        async function saveFile(blob, name) {
            try {
                if(directoryHandle) {
                    const fh = await directoryHandle.getFileHandle(name, { create: true });
                    const w = await fh.createWritable();
                    await w.write(blob);
                    await w.close();
                    showToast("Saved to Drive", "success", name);
                } else {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = name;
                    a.click();
                    showToast("Saved Locally", "success", "Downloads Folder");
                }
            } catch(e) { showToast("Error Saving", "error", "Check permissions"); }
        }

        // --- 4. Capture Logic ---
        async function capturePhoto() {
            const flash = document.getElementById('flash-layer');
            flash.style.opacity = 1;
            setTimeout(() => flash.style.opacity = 0, 150);

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            if(facingMode === 'user') { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(b => {
                updatePreview(b);
                saveFile(b, `IMG_${Date.now()}.png`);
            }, 'image/png');
        }

        function toggleRecording() {
            if(!isRecording) {
                recordedChunks = [];
                // Use high bitrate for T4 Pro quality
                const options = { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 8000000 }; 
                try { mediaRecorder = new MediaRecorder(stream, options); } 
                catch(e) { mediaRecorder = new MediaRecorder(stream); }

                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const b = new Blob(recordedChunks, { type: 'video/webm' });
                    updatePreview(b);
                    saveFile(b, `VID_${Date.now()}.webm`);
                };
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('video-inner').classList.add('scale-50', 'rounded-md');
                document.getElementById('timer-pill').classList.remove('hidden');
                startTimer();
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('video-inner').classList.remove('scale-50', 'rounded-md');
                document.getElementById('timer-pill').classList.add('hidden');
                stopTimer();
            }
        }

        // --- 5. Helpers ---
        function setMode(m) {
            mode = m;
            const btnP = document.getElementById('btn-photo');
            const btnV = document.getElementById('btn-video');
            const sP = document.getElementById('shutter-photo');
            const sV = document.getElementById('shutter-video');
            const ind = document.getElementById('mode-indicator');

            if(mode === 'photo') {
                ind.style.transform = 'translateX(0)';
                btnP.classList.remove('text-gray-400');
                btnV.classList.add('text-gray-400');
                sP.classList.remove('hidden');
                sV.classList.add('hidden');
            } else {
                ind.style.transform = 'translateX(100%)';
                btnP.classList.add('text-gray-400');
                btnV.classList.remove('text-gray-400');
                sP.classList.add('hidden');
                sV.classList.remove('hidden');
            }
        }

        function flipCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            startCamera();
        }

        function updatePreview(b) {
            document.getElementById('last-preview').src = URL.createObjectURL(b);
            document.getElementById('last-preview').classList.remove('hidden');
            document.getElementById('no-preview').classList.add('hidden');
        }

        function showToast(m, t, s) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = m;
            document.getElementById('toast-sub').innerText = s;
            document.getElementById('toast-icon').setAttribute('data-lucide', t==='success'?'check-circle':'alert-circle');
            lucide.createIcons();
            toast.style.opacity = 1;
            setTimeout(() => toast.style.opacity = 0, 3000);
        }

        function startTimer() {
            let s = 0;
            document.getElementById('timer-text').innerText = "00:00";
            timerInt = setInterval(() => {
                s++;
                const m = Math.floor(s/60).toString().padStart(2,'0');
                const sec = (s%60).toString().padStart(2,'0');
                document.getElementById('timer-text').innerText = `${m}:${sec}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInt); }
        function openGalleryTip() { showToast("Recent File", "success", "Saved in selected folder"); }

        // Init (Start with Back Camera default for better specs)
        startCamera();
    </script>
</body>
</html>